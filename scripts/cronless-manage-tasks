#!/bin/bash
# cronless-manage-tasks â€” ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ cronless (Ð±ÐµÐ· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð²)

set -euo pipefail

UNIT_DIR="$HOME/.config/systemd/user"
CONF_DIR="$HOME/.config/systemd/user/task.d"

mkdir -p "$UNIT_DIR" "$CONF_DIR"

ACTION="${1:-}"

usage() {
  echo "Usage:"
  echo "  $0 add <task_name> \"<command>\" \"<OnCalendar>\""
  echo "  $0 remove <task_name>"
  echo "  $0 list"
  exit 1
}

case "$ACTION" in
  add)
    [ $# -eq 4 ] || usage

    TASK_NAME="$2"
    TASK_COMMAND="$3"
    TASK_SCHEDULE="$4"

    SERVICE_FILE="$UNIT_DIR/${TASK_NAME}.service"
    TIMER_FILE="$UNIT_DIR/${TASK_NAME}.timer"
    CONF_FILE="$CONF_DIR/cronless-${TASK_NAME}.conf"

    if [ -e "$SERVICE_FILE" ] || [ -e "$TIMER_FILE" ] || [ -e "$CONF_FILE" ]; then
      echo "âŒ Task '$TASK_NAME' already exists"
      exit 1
    fi

    # ---------- task config ----------
    cat > "$CONF_FILE" <<EOF
[Task]
Environment=TASK_COMMAND=$TASK_COMMAND
EOF

    # ---------- service ----------
    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Cronless task $TASK_NAME

[Service]
Type=oneshot
ExecStart=/usr/bin/cronless-run-task $TASK_NAME
EOF

    # ---------- timer ----------
    cat > "$TIMER_FILE" <<EOF
[Unit]
Description=Cronless timer $TASK_NAME

[Timer]
OnCalendar=$TASK_SCHEDULE
Persistent=true

[Install]
WantedBy=timers.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable --now "$(basename "$TIMER_FILE")"

    echo "âœ… Task '$TASK_NAME' added"
    echo "   Command : $TASK_COMMAND"
    echo "   Schedule: $TASK_SCHEDULE"
    ;;

  remove)
    [ $# -eq 2 ] || usage

    TASK_NAME="$2"

    systemctl --user disable --now "$TASK_NAME.timer" 2>/dev/null || true

    rm -f \
      "$UNIT_DIR/${TASK_NAME}.service" \
      "$UNIT_DIR/${TASK_NAME}.timer" \
      "$CONF_DIR/cronless-${TASK_NAME}.conf"

    systemctl --user daemon-reload

    echo "ðŸ—‘ Task '$TASK_NAME' removed"
    ;;

  list)
    echo "ðŸ“‹ Configured tasks:"
    shopt -s nullglob
    for conf in "$CONF_DIR"/cronless-*.conf; do
      TASK_NAME="$(basename "$conf" | sed 's/^cronless-\(.*\)\.conf$/\1/')"

      CMD=$(grep '^Environment=TASK_COMMAND=' "$conf" | cut -d= -f2-)
      TIMER="$UNIT_DIR/$TASK_NAME.timer"

      if [ -f "$TIMER" ]; then
        SCHEDULE=$(grep '^OnCalendar=' "$TIMER" | cut -d= -f2-)
        STATUS=$(systemctl --user is-active "$TASK_NAME.timer" 2>/dev/null || echo inactive)
      else
        SCHEDULE="â€”"
        STATUS="missing timer"
      fi

      echo " - $TASK_NAME"
      echo "     command : $CMD"
      echo "     schedule: $SCHEDULE"
      echo "     status  : $STATUS"
    done
    ;;

  *)
    usage
    ;;
esac
