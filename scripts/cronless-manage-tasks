#!/bin/bash
# cronless-manage-tasks â€” add/remove/list Cronless tasks

set -euo pipefail

CRONLESS_DIR="$HOME/.config/cronless"
TASK_DIR="$CRONLESS_DIR/tasks"
SYSTEMD_USER_DIR="$HOME/.config/systemd/user"
STATUS_DIR="$CRONLESS_DIR/status"

mkdir -p "$TASK_DIR" "$SYSTEMD_USER_DIR" "$STATUS_DIR"

ACTION="${1:-}"

die() {
  echo "âŒ $*" >&2
  exit 1
}

usage() {
  cat <<EOF
Usage:
  cronless-manage-tasks add <task-name> "<command>" "<OnCalendar>"
  cronless-manage-tasks remove <task-name>
  cronless-manage-tasks list
EOF
}

case "$ACTION" in
  add)
    TASK_NAME="${2:-}"
    TASK_COMMAND="${3:-}"
    TASK_SCHEDULE="${4:-}"

    [[ -n "$TASK_NAME" && -n "$TASK_COMMAND" && -n "$TASK_SCHEDULE" ]] || usage

    TASK_CONF="$TASK_DIR/${TASK_NAME}.conf"
    TIMER_UNIT="$SYSTEMD_USER_DIR/task-${TASK_NAME}.timer"

    # 1ï¸âƒ£ task config (command only)
    cat > "$TASK_CONF" <<EOF
# Generated by cronless
TASK_COMMAND="$TASK_COMMAND"
EOF

    # 2ï¸âƒ£ systemd timer (schedule only)
    cat > "$TIMER_UNIT" <<EOF
[Unit]
Description=Cronless timer $TASK_NAME

[Timer]
OnCalendar=$TASK_SCHEDULE
Persistent=true

[Install]
WantedBy=timers.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable --now "task-${TASK_NAME}.timer"

    echo "âœ… Task '$TASK_NAME' added"
    echo "   Command : $TASK_COMMAND"
    echo "   Schedule: $TASK_SCHEDULE"
    ;;

  remove)
    TASK_NAME="${2:-}"
    [[ -n "$TASK_NAME" ]] || usage

    systemctl --user disable --now "task-${TASK_NAME}.timer" 2>/dev/null || true
    rm -f \
      "$TASK_DIR/${TASK_NAME}.conf" \
      "$SYSTEMD_USER_DIR/task-${TASK_NAME}.timer"

    systemctl --user daemon-reload

    echo "ðŸ—‘ Task '$TASK_NAME' removed"
    ;;

  list)
    echo "ðŸ“‹ Cronless tasks:"
    echo

    shopt -s nullglob
    for conf in "$TASK_DIR"/*.conf; do
      TASK_NAME="$(basename "$conf" .conf)"
      TIMER="task-${TASK_NAME}.timer"

      # command
      TASK_COMMAND=$(sed -n 's/^TASK_COMMAND="\?\(.*\)"\?/\1/p' "$conf")

      # schedule
      TIMER_FILE="$SYSTEMD_USER_DIR/$TIMER"
      if [[ -f "$TIMER_FILE" ]]; then
        TASK_SCHEDULE=$(sed -n 's/^OnCalendar=//p' "$TIMER_FILE")
      else
        TASK_SCHEDULE="(missing timer)"
      fi

      STATUS=$(systemctl --user is-active "$TIMER" 2>/dev/null || echo inactive)

      STATUS_FILE="$STATUS_DIR/${TASK_NAME}.last"
      if [[ -f "$STATUS_FILE" ]]; then
        LAST_RESULT=$(grep '^result=' "$STATUS_FILE" | cut -d= -f2)
        LAST_DURATION=$(grep '^duration=' "$STATUS_FILE" | cut -d= -f2)
        EXTRA="last: $LAST_RESULT, ${LAST_DURATION}s"
      else
        EXTRA="no runs yet"
      fi

      printf " - %-20s [%s]\n" "$TASK_NAME" "$STATUS"
      printf "   cmd: %s\n" "$TASK_COMMAND"
      printf "   sch: %s\n" "$TASK_SCHEDULE"
      printf "   %s\n\n" "$EXTRA"
    done
    ;;

  *)
    usage
    exit 1
    ;;
esac
