#!/bin/bash
# cronless-manage-tasks â€” ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ cronless (Ð±ÐµÐ· systemd-ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð²)

set -euo pipefail

UNIT_DIR="$HOME/.config/systemd/user/cronless"
mkdir -p "$UNIT_DIR"

ACTION="${1:-}"

usage() {
  echo "Usage:"
  echo "  $0 add <task_name> \"<command>\" \"<OnCalendar>\""
  echo "  $0 remove <task_name>"
  echo "  $0 list"
  exit 1
}

case "$ACTION" in
  add)
    [ $# -eq 4 ] || usage

    TASK_NAME="$2"
    TASK_COMMAND="$3"
    TASK_SCHEDULE="$4"

    SERVICE_FILE="$UNIT_DIR/${TASK_NAME}.service"
    TIMER_FILE="$UNIT_DIR/${TASK_NAME}.timer"

    if [ -e "$SERVICE_FILE" ] || [ -e "$TIMER_FILE" ]; then
      echo "âŒ Task '$TASK_NAME' already exists"
      exit 1
    fi

    # ---------- service ----------
    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Cronless task $TASK_NAME

[Service]
Type=oneshot
ExecStart=/usr/bin/bash -c '$TASK_COMMAND'
EOF

    # ---------- timer ----------
    cat > "$TIMER_FILE" <<EOF
[Unit]
Description=Cronless timer $TASK_NAME

[Timer]
OnCalendar=$TASK_SCHEDULE
Persistent=true

[Install]
WantedBy=timers.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable --now "$(basename "$TIMER_FILE")"

    echo "âœ… Task '$TASK_NAME' added"
    echo "   Command : $TASK_COMMAND"
    echo "   Schedule: $TASK_SCHEDULE"
    ;;

  remove)
    [ $# -eq 2 ] || usage

    TASK_NAME="$2"
    SERVICE_FILE="$UNIT_DIR/${TASK_NAME}.service"
    TIMER_FILE="$UNIT_DIR/${TASK_NAME}.timer"

    systemctl --user disable --now "$(basename "$TIMER_FILE")" 2>/dev/null || true

    rm -f "$SERVICE_FILE" "$TIMER_FILE"

    systemctl --user daemon-reload

    echo "ðŸ—‘ Task '$TASK_NAME' removed"
    ;;

  list)
    echo "ðŸ“‹ Configured tasks:"
    shopt -s nullglob
    for timer in "$UNIT_DIR"/*.timer; do
      TASK_NAME="$(basename "$timer" .timer)"
      SERVICE="$UNIT_DIR/$TASK_NAME.service"

      SCHEDULE=$(grep '^OnCalendar=' "$timer" | cut -d= -f2-)
      COMMAND=$(grep '^ExecStart=' "$SERVICE" | sed 's|ExecStart=/usr/bin/bash -c ||')

      STATUS=$(systemctl --user is-active "$TASK_NAME.timer" 2>/dev/null || echo inactive)

      echo " - $TASK_NAME"
      echo "     command : $COMMAND"
      echo "     schedule: $SCHEDULE"
      echo "     status  : $STATUS"
    done
    ;;

  *)
    usage
    ;;
esac
