#!/bin/bash
# cronless-weekly-report — генерация недельного отчёта через journalctl с вычислением Duration

# Получаем список активных задач
TASKS=($(cronless-manage-tasks list | awk '/^ - / {print $2}'))

SINCE="$(date -d '7 days ago' '+%Y-%m-%d %H:%M:%S')"

for TASK in "${TASKS[@]}"; do
    # Берём все логи за неделю с unix-временем
    LOGS=$(journalctl --user -u "${TASK}.service" --since "$SINCE" --no-pager --output=short-unix)

    [[ -z "$LOGS" ]] && continue

    declare -a START_TIMES
    declare -a END_TIMES
    declare -a RESULTS

    while IFS= read -r line; do
        TIME=$(echo "$line" | awk '{print $1}')
        if [[ "$line" =~ Starting ]]; then
            START_TIMES+=("$TIME")
        elif [[ "$line" =~ Finished ]]; then
            END_TIMES+=("$TIME")
            RESULTS+=("SUCCESS")
        elif [[ "$line" =~ Failed ]]; then
            END_TIMES+=("$TIME")
            RESULTS+=("FAIL")
        fi
    done <<< "$LOGS"

    TOTAL=${#RESULTS[@]}
    SUCCESS=$(grep -o "SUCCESS" <<< "${RESULTS[*]}" | wc -l)
    FAIL=$((TOTAL - SUCCESS))

    CHARS=""
    for res in "${RESULTS[@]: -20}"; do
        [[ "$res" == "SUCCESS" ]] && CHARS+="✔" || CHARS+="✖"
    done

    LAST_RUN_UNIX=${END_TIMES[-1]}
    LAST_RUN=$(date -d "@$LAST_RUN_UNIX" '+%Y-%m-%d %H:%M:%S')
    LAST_RESULT=${RESULTS[-1]}

    DURATIONS=()
    for i in "${!START_TIMES[@]}"; do
        # Отбрасываем дробную часть, оставляем целое число секунд
        start=${START_TIMES[i]%.*}
        end=${END_TIMES[i]%.*}
        duration=$(( (end - start) / 60 ))
        DURATIONS+=("$duration")
    done

    MAX_DURATION=$(printf "%s\n" "${DURATIONS[@]}" | sort -nr | head -1)

    echo "Task: $TASK"
    echo "  Last run: $LAST_RUN"
    echo "  Last result: $LAST_RESULT"
    echo "  Total runs: $TOTAL ($CHARS)"
    echo "  Success: $SUCCESS, Fail: $FAIL"
    echo "  Max duration: ${MAX_DURATION:-"-"}m"
    echo ""

    unset START_TIMES END_TIMES RESULTS DURATIONS
done
