#!/bin/bash
# cronless-weekly-report — генерация недельного отчёта

STATUS_DIR="$HOME/task_logs/status"
LOG_DIR="$HOME/task_logs/logs"

for status_file in "$STATUS_DIR"/*_last_status.txt; do
    [ -f "$status_file" ] || continue
    TASK=$(basename "$status_file" | sed 's/_last_status.txt//')

    LAST_RUN=$(grep "^Last run:" "$status_file" | cut -d' ' -f3-)
    LAST_RESULT=$(grep "^Last result:" "$status_file" | cut -d' ' -f3)
    DURATION=$(grep "^Duration:" "$status_file" | cut -d' ' -f2)

    # Подсчёт запусков за неделю
    RUNS=($(ls "$LOG_DIR/${TASK}"* 2>/dev/null))
    TOTAL=${#RUNS[@]}
    SUCCESS=$(grep -l "SUCCESS" "${RUNS[@]}" 2>/dev/null | wc -l)
    FAIL=$((TOTAL - SUCCESS))

    # Формируем символы последовательности последних 20 запусков
    CHARS=""
    for run in "${RUNS[@]: -20}"; do
        if grep -q "SUCCESS" "$run"; then
            CHARS+="✔"
        else
            CHARS+="✖"
        fi
    done

    MAX_DURATION=$(grep -h "Duration:" "${RUNS[@]}" 2>/dev/null | cut -d' ' -f2 | sort -nr | head -1)

    echo "Task: $TASK"
    echo "  Last run: $LAST_RUN"
    echo "  Last result: $LAST_RESULT"
    echo "  Total runs: $TOTAL ($CHARS)"
    echo "  Success: $SUCCESS, Fail: $FAIL"
    echo "  Max duration: ${MAX_DURATION}m"
    echo ""
done
