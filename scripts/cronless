#!/bin/bash
# cronless â€” ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ cronless

set -euo pipefail
[[ -z $USER ]] && USER="$(id -un)"

if [[ $USER == root ]]; then
  SYSTEMCTL="systemctl"
  JOURNALCTL="journalctl"
  UNIT_DIR="/etc/systemd/system"
else
  SYSTEMCTL="systemctl --user"
  JOURNALCTL="journalctl --user"
  UNIT_DIR="$HOME/.config/systemd/user"
  loginctl enable-linger "$USER"
fi
TASKS_DIR="$HOME/.config/systemd/user/cronless-tasks"

ACTION="${1:-}"

if [[ $# -gt 1 ]]; then # It's command with task name in params
  TASK_NAME="$2"
  SERVICE_FILE="$UNIT_DIR/cronless-${TASK_NAME}.service"
  TIMER_FILE="$UNIT_DIR/cronless-${TASK_NAME}.timer"
  TASK_FILE="$TASKS_DIR/${TASK_NAME}"
fi

[[ -d "$UNIT_DIR" ]] || mkdir -p "$UNIT_DIR"
[[ -d "$TASKS_DIR" ]] || mkdir -p "$TASKS_DIR"

usage() {
  echo "Usage:"
  echo "  $0 add <task_name> \"<command>\" \"<OnCalendar>\""
  echo "  $0 remove <task_name>"
  echo "  $0 list"
  echo "  $0 run <task_name>"
  echo "  $0 logs <task_name>"
  echo "  $0 enable <task_name>"
  echo "  $0 disable <task_name>"
  exit 1
}

is_one_line_bash_script() {
    local file="$1"

    # Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹
    [[ -f "$file" && -x "$file" ]] || return 1

    # Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° shebang Ð½Ð° bash
    head -n 1 "$file" | grep -Eq '^#!.*/(env +)?bash' || return 1

    # ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸, ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰Ð¸Ðµ ÐÐ• Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹/Ñ‚Ð°Ð±Ñ‹
    local lines
    lines=$(grep -cEv '^[[:space:]]*$' "$file")

    [[ "$lines" -eq 2 ]]
}

case "$ACTION" in
  add)
    [[ $# -eq 4 ]] || usage

    TASK_COMMAND="$3"
    TASK_SCHEDULE="$4"

    if [ -e "$SERVICE_FILE" ] || [ -e "$TIMER_FILE" ] || [ -e "$TASK_FILE" ]; then
      echo "âŒ Task '$TASK_NAME' already exists"
      exit 1
    fi

    # ---------- task config ----------
    cat > "$TASK_FILE" <<EOF
#!/usr/bin/env bash
$TASK_COMMAND
EOF
    chmod +x "$TASK_FILE"

    # ---------- service ----------
    cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Cronless task $TASK_NAME

[Service]
Type=oneshot
ExecStart=/usr/bin/cronless run $TASK_NAME
EOF

    # ---------- timer ----------
    cat > "$TIMER_FILE" <<EOF
[Unit]
Description=Cronless timer $TASK_NAME

[Timer]
OnCalendar=$TASK_SCHEDULE
Persistent=true

[Install]
WantedBy=timers.target
EOF

    $SYSTEMCTL daemon-reload
    $SYSTEMCTL enable --now "$(basename "$TIMER_FILE")"

    echo "âœ… Task '$TASK_NAME' added"
    echo "   Command : $TASK_COMMAND"
    echo "   Schedule: $TASK_SCHEDULE"
    ;;

  remove|rm)
    [[ $# -eq 2 ]] || usage

    $SYSTEMCTL disable --now "cronless-$TASK_NAME.timer" 2>/dev/null || true

    rm -f \
      "$UNIT_DIR/cronless-${TASK_NAME}.service" \
      "$UNIT_DIR/cronless-${TASK_NAME}.timer" \
      "$TASKS_DIR/${TASK_NAME}"

    $SYSTEMCTL daemon-reload
    $SYSTEMCTL reset-failed "cronless-$TASK_NAME.service"

    echo "ðŸ—‘ Task '$TASK_NAME' removed"
    ;;

  list|ls)
    echo "ðŸ“‹ Configured tasks:"
    shopt -s nullglob
    for TASK_FILE in "$TASKS_DIR"/*; do
      TASK_NAME="${TASK_FILE##*/}"

      CMD="$TASK_FILE"
      if is_one_line_bash_script "$TASK_FILE"; then
        line=$(sed -E '1{/^#!.*bash/d}; /^[[:space:]]*$/d' "$TASK_FILE")
        [[ $(wc -l <<<"$line") -eq 1 ]] && CMD=$line
      fi

      TIMER="$UNIT_DIR/cronless-$TASK_NAME.timer"

      if [ -f "$TIMER" ]; then
        SCHEDULE=$(grep '^OnCalendar=' "$TIMER" | cut -d= -f2-)
        STATUS=$($SYSTEMCTL is-active "cronless-$TASK_NAME.timer" 2>/dev/null)
      else
        SCHEDULE="â€”"
        STATUS="missing timer"
      fi

      echo " - $TASK_NAME"
      echo "     command    : $CMD"
      echo "     schedule   : $SCHEDULE"
      echo "     status     : $STATUS"
    done
    ;;

  logs)
    [[ $# -eq 2 ]] || usage
    $JOURNALCTL -u "${SERVICE_FILE##*/}"
    ;;

  run|exec|start)
    [[ $# -eq 2 ]] || usage
    if [ ! -f "$TASK_FILE" ]; then
        echo "Task $TASK_NAME not found!" >&2
        exit 1
    fi
    $TASK_FILE
    EXIT_CODE=$?
    exit $EXIT_CODE
    ;;

  enable|disable)
    [[ $# -eq 2 ]] || usage
    if [ ! -f "$TASK_FILE" ]; then
        echo "Task $TASK_NAME not found!" >&2
        exit 1
    fi
    $SYSTEMCTL "$1" "${TIMER_FILE##*/}"
    EXIT_CODE=$?
    exit $EXIT_CODE
    ;;

  *)
    usage
    ;;
esac
